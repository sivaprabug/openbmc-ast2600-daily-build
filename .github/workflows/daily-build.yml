name: Daily OpenBMC AST2600 Build + Release

on:
  schedule:
    - cron: "30 18 * * *"   # 12:00 AM IST daily
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 420

    steps:
      # -----------------------------
      # YOCTO DEPENDENCIES
      # -----------------------------
      - name: Install Yocto Dependencies
        run: |
          sudo apt update
          sudo apt install -y gawk wget git diffstat unzip texinfo gcc-multilib \
            build-essential chrpath socat cpio python3 python3-pip python3-pexpect \
            xz-utils debianutils iputils-ping python3-git python3-jinja2 zstd \
            ccache

      # -----------------------------
      # RESTORE SSTATE CACHE
      # -----------------------------
      - name: Restore sstate cache
        uses: actions/cache@v3
        with:
          path: ~/openbmc/sstate-cache
          key: sstate-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            sstate-${{ runner.os }}-

      # -----------------------------
      # RESTORE CCACHE
      # -----------------------------
      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            ccache-${{ runner.os }}-

      # -----------------------------
      # CLONE OPENBMC
      # -----------------------------
      - name: Clone OpenBMC
        run: |
          git clone https://github.com/openbmc/openbmc ~/openbmc
          cd ~/openbmc

          # Create build directory and local.conf
          . setup evb-ast2600 evb-ast2600

          # Enable ccache + sstate
          echo 'INHERIT += "ccache"' >> evb-ast2600/conf/local.conf
          echo 'SSTATE_DIR = "~/openbmc/sstate-cache"' >> evb-ast2600/conf/local.conf

      # -----------------------------
      # BUILD IMAGE
      # -----------------------------
      - name: Build AST2600 Image
        run: |
          cd ~/openbmc
          . setup evb-ast2600 evb-ast2600
          bitbake obmc-phosphor-image -v

      # -----------------------------
      # PACKAGE ARTIFACTS
      # -----------------------------
      - name: Prepare artifacts
        run: |
          mkdir -p release
          cp ~/openbmc/evb-ast2600/tmp/deploy/images/evb-ast2600/* release/

      # -----------------------------
      # CREATE GITHUB RELEASE
      # -----------------------------
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "daily-${{ github.run_number }}"
          name: "Daily AST2600 Build #${{ github.run_number }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # UPLOAD RELEASE ASSETS
      # -----------------------------
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "daily-${{ github.run_number }}"
          files: release/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------
  # AUTO DELETE OLD RELEASES (KEEP 7)
  # ------------------------------------
  clean:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Delete old releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 7
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
